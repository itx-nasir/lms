{% extends "base.html" %}

{% block title %}Orders - Lab Management System{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-clipboard-list me-2"></i>Test Orders</h1>
        <a href="/orders/new" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i>New Order
        </a>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-md-4">
            <label for="statusFilter" class="form-label">Filter by Status:</label>
            <select class="form-select" id="statusFilter">
                <option value="">All Orders</option>
                <option value="pending">Pending</option>
                <option value="completed">Completed</option>
            </select>
        </div>
        <div class="col-md-4">
            <label for="patientSearch" class="form-label">Search by Patient:</label>
            <input type="text" class="form-control" id="patientSearch" placeholder="Enter patient name...">
        </div>
        <div class="col-md-4">
            <label for="dateFilter" class="form-label">Filter by Date:</label>
            <input type="date" class="form-control" id="dateFilter">
        </div>
    </div>

    <!-- Orders Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-primary">
                        <tr>
                            <th>Order ID</th>
                            <th>Patient</th>
                            <th>Ordered Date</th>
                            <th>Total Amount</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}
                        <tr class="order-row" 
                            data-status="{{ order.status }}" 
                            data-patient="{{ order.patient.name.lower() }}"
                            data-date="{{ order.ordered_at.strftime('%Y-%m-%d') }}">
                            <td>ORD-{{ order.id }}</td>
                            <td>
                                <strong>{{ order.patient.name }}</strong><br>
                                <small class="text-muted">Age: {{ order.patient.age }}, {{ order.patient.gender }}</small>
                            </td>
                            <td>{{ order.ordered_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>PKR {{ "%.2f"|format(order.total_amount) }}</td>
                            <td>
                                {% if order.status == 'pending' %}
                                    <span class="badge bg-warning">Pending</span>
                                {% else %}
                                    <span class="badge bg-success">Completed</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="/orders/{{ order.id }}" class="btn btn-sm btn-outline-info">
                                    <i class="fas fa-eye"></i> View
                                </a>
                                {% if order.status == 'pending' %}
                                <form method="post" action="/orders/{{ order.id }}/complete" class="d-inline">
                                    <button type="submit" class="btn btn-sm btn-outline-success" 
                                            onclick="return confirm('Mark this order as completed?')">
                                        <i class="fas fa-check"></i> Complete
                                    </button>
                                </form>
                                <form method="post" action="/orders/{{ order.id }}/delete" class="d-inline">
                                    <button type="submit" class="btn btn-sm btn-outline-danger" 
                                            onclick="return confirm('Are you sure you want to delete this order? This action cannot be undone.')">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </form>
                                {% else %}
                                <a href="/reports/{{ order.id }}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-file-alt"></i> Report
                                </a>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                No orders found
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const statusFilter = document.getElementById('statusFilter');
    const patientSearch = document.getElementById('patientSearch');
    const dateFilter = document.getElementById('dateFilter');
    const orderRows = document.querySelectorAll('.order-row');

    function filterOrders() {
        const selectedStatus = statusFilter.value;
        const searchTerm = patientSearch.value.toLowerCase();
        const selectedDate = dateFilter.value;
        let visibleCount = 0;

        orderRows.forEach(row => {
            const matchesStatus = selectedStatus === '' || row.dataset.status === selectedStatus;
            const matchesPatient = searchTerm === '' || row.dataset.patient.includes(searchTerm);
            const matchesDate = selectedDate === '' || row.dataset.date === selectedDate;

            if (matchesStatus && matchesPatient && matchesDate) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });

        // Update empty state
        updateEmptyState(visibleCount);
    }

    function updateEmptyState(visibleCount) {
        const existingEmptyRow = document.querySelector('.no-orders-filtered');
        const tbody = document.querySelector('tbody');

        if (visibleCount === 0 && orderRows.length > 0) {
            if (!existingEmptyRow) {
                const emptyRow = document.createElement('tr');
                emptyRow.className = 'no-orders-filtered';
                emptyRow.innerHTML = `
                    <td colspan="6" class="text-center text-muted py-4">
                        <i class="fas fa-filter me-2"></i>No orders match your filters
                        <br><small class="text-muted mt-1">Try adjusting your search criteria</small>
                    </td>
                `;
                tbody.appendChild(emptyRow);
            } else {
                existingEmptyRow.style.display = '';
            }
        } else if (existingEmptyRow) {
            existingEmptyRow.style.display = 'none';
        }
    }

    // Event listeners
    statusFilter.addEventListener('change', filterOrders);
    patientSearch.addEventListener('input', filterOrders);
    dateFilter.addEventListener('change', filterOrders);

    // Clear filters button
    const clearFiltersBtn = document.createElement('button');
    clearFiltersBtn.type = 'button';
    clearFiltersBtn.className = 'btn btn-outline-secondary';
    clearFiltersBtn.innerHTML = '<i class="fas fa-times me-1"></i>Clear Filters';
    
    const filterRow = document.querySelector('.row.mb-4');
    const clearDiv = document.createElement('div');
    clearDiv.className = 'col-12 mt-2';
    clearDiv.appendChild(clearFiltersBtn);
    filterRow.appendChild(clearDiv);

    clearFiltersBtn.addEventListener('click', function() {
        statusFilter.value = '';
        patientSearch.value = '';
        dateFilter.value = '';
        filterOrders();
    });
});
</script>
{% endblock %}